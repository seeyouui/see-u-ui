name: Sync SeeYouUI to NPM # 工作流名称，显示在 Actions 面板中

# 1. 触发条件配置
on:
  push:
    branches: [main] # 当 main 分支有代码推送时触发（如果是 master 请修改）
    paths: # 路径过滤器：只有当以下文件夹发生变化时才触发，避免改了 README 也触发同步
      - "uni_modules/see-u-ui/**"
      # - '你的其他源码目录/**'

jobs:
  sync-code:
    runs-on: ubuntu-latest # 使用 GitHub 提供的最新 Linux 环境运行

    steps:
      # ----------------------------------------------------------------
      # 第一步：检出（下载）源仓库代码
      # ----------------------------------------------------------------
      - name: Checkout Source Repo (Uniapp)
        uses: actions/checkout@v4
        with:
          path: source-repo # 将代码下载到 source-repo 文件夹，防止混淆

      # ----------------------------------------------------------------
      # 第二步：检出（下载）目标仓库代码
      # ----------------------------------------------------------------
      - name: Checkout Target Repo (NPM Package)
        uses: actions/checkout@v4
        with:
          repository: seeyouui/see-u-ui-npm
          token: ${{ secrets.TARGET_REPO_TOKEN }} # 使用刚才配置的 Secret 权限
          path: target-repo # 将代码下载到 target-repo 文件夹
          ref: main # 确保拉取的是 main 分支

      # ----------------------------------------------------------------
      # 第三步：同步代码 (核心逻辑)
      # ----------------------------------------------------------------
      - name: Sync Files via Rsync
        run: |
          echo "开始同步文件..."

          # 示例1：同步组件目录
          rsync -av --delete source-repo/uni_modules/see-u-ui/ target-repo/src/

          # 示例2：(可选) 如果还有 utils 目录要同步，可以追加命令
          # rsync -av source-repo/common/utils/ target-repo/src/utils/

          echo "文件同步完成，准备检查变更..."

      # ----------------------------------------------------------------
      # 第四步：提交并推送
      # ----------------------------------------------------------------
      - name: Commit and Push
        working-directory: target-repo # 切换到目标仓库目录进行 Git 操作
        run: |
          # 配置临时的 Git 用户信息（显示在 commit 记录里）
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

          # 添加所有变更
          git add .

          # 检查是否有变更需要提交
          if git diff --staged --quiet; then
            echo "检测到没有文件发生变化，跳过提交步骤。"
          else
            echo "检测到文件变更，正在提交..."
            TZ='Asia/Shanghai' git commit -m "同步了：SeeYouUI 到 see-u-ui-npm $(date +'%Y-%m-%d %H:%M:%S')"
            
            # 推送回 NPM 仓库
            git push origin main
            echo "推送成功！"
          fi
