name: Sync SeeYouUI to CLI

# 1. 触发条件配置
on:
  push:
    branches: [main]
    # 这里去掉了 paths 限制，因为你要同步根目录所有文件，任何变动都应该触发

jobs:
  sync-code:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------------
      # 第一步：检出（下载）源仓库代码 (see-u-ui)
      # ----------------------------------------------------------------
      - name: Checkout Source Repo (see-u-ui)
        uses: actions/checkout@v4
        with:
          path: source-repo

      # ----------------------------------------------------------------
      # 第二步：检出（下载）目标仓库代码 (see-u-ui-cli)
      # ----------------------------------------------------------------
      - name: Checkout Target Repo (see-u-ui-cli)
        uses: actions/checkout@v4
        with:
          repository: seeyouui/see-u-ui-cli # 修改：目标仓库
          token: ${{ secrets.SYNC_TOKEN }} # 修改：Token 名称
          path: target-repo
          ref: main

      # ----------------------------------------------------------------
      # 第三步：同步代码 (核心逻辑：根目录 -> src)
      # ----------------------------------------------------------------
      - name: Sync Files via Rsync
        run: |
          echo "确保目标目录 src 存在..."
          mkdir -p target-repo/src

          echo "开始同步文件..."

          # 核心修改说明：
          # 1. source-repo/  --> 源仓库根目录（注意末尾斜杠，表示拷贝内容）
          # 2. target-repo/src/ --> 目标仓库的 src 目录
          # 3. --exclude: 必须排除 .git 和 .github，否则会把版本控制文件也拷进 src 里，导致混乱
          # 4. --delete: 会删除 target-repo/src/ 中那些源仓库里没有的文件（实现清空旧文件效果）

          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'node_modules/' \
            source-repo/ target-repo/src/

          echo "文件同步完成，准备检查变更..."

      # ----------------------------------------------------------------
      # 第四步：提交并推送
      # ----------------------------------------------------------------
      - name: Commit and Push
        working-directory: target-repo
        run: |
          # 配置 git 用户信息
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

          # 添加所有变更
          git add .

          # 检查是否有变更
          if git diff --staged --quiet; then
            echo "检测到没有文件发生变化，跳过提交步骤。"
          else
            echo "检测到文件变更，正在提交..."
            TZ='Asia/Shanghai' git commit -m "同步了：SeeYouUI 到 see-u-ui-cli $(date +'%Y-%m-%d %H:%M:%S')"
            
            # 推送
            git push origin main
            echo "推送成功！"
          fi
